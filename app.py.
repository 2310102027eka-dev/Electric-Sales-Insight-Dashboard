import os
import pandas as pd
import streamlit as st
import plotly.express as px
from supabase import create_client, Client
from datetime import datetime

# --- 1. KONFIGURASI HALAMAN ---
st.set_page_config(
    page_title="Dashboard Analisis Refund",
    page_icon="ðŸ“Š",
    layout="wide"
)

# --- 2. KONEKSI DATABASE (SECURE) ---
@st.cache_resource
def init_connection():
    """Inisialisasi koneksi ke Supabase menggunakan Environment Variables."""
    url = os.environ.get("SUPABASE_URL")
    key = os.environ.get("SUPABASE_KEY")
    
    if not url or not key:
        st.error("Kredensial database tidak ditemukan! Pastikan SUPABASE_URL dan SUPABASE_KEY sudah diatur.")
        st.stop()
        
    return create_client(url, key)

supabase: Client = init_connection()

# --- 3. DATA FETCHING & PROCESSING ---
@st.cache_data(ttl=600)  # Data disimpan di cache selama 10 menit
def fetch_data():
    """Mengambil semua data dari tabel dan melakukan preprocessing."""
    try:
        # Mengambil data dari tabel [datapenjualanbaru]
        # Catatan: Supabase secara default membatasi 1000 baris. 
        # Untuk data sangat besar, diperlukan logic pagination.
        response = supabase.table("datapenjualanbaru").select("*").execute()
        df = pd.DataFrame(response.data)
        
        if df.empty:
            return df

        # Konversi format tanggal [cancel_time] menjadi datetime
        df['cancel_time'] = pd.to_datetime(df['cancel_time'], errors='coerce')
        
        # Pastikan kolom [total_refund] adalah numerik
        df['total_refund'] = pd.to_numeric(df['total_refund'], errors='coerce').fillna(0)
        
        # Hapus baris yang tidak memiliki tanggal pembatalan (opsional, tergantung kebutuhan)
        df = df.dropna(subset=['cancel_time'])
        
        return df
    except Exception as e:
        st.error(f"Gagal mengambil data: {str(e)}")
        return pd.DataFrame()

# --- 4. LOGIKA UTAMA APP ---
def main():
    st.title("ðŸš€ Real-time Sales & Refund Dashboard")
    st.markdown("Data bersumber langsung dari tabel `datapenjualanbaru` di Supabase.")

    # Load Data
    df = fetch_data()

    if df.empty:
        st.warning("Tidak ada data yang tersedia untuk ditampilkan.")
        return

    # --- 5. LOGIKA KPI ---
    total_refund_value = df['total_refund'].sum()
    total_records = len(df)

    # Menampilkan KPI di bagian atas
    col1, col2 = st.columns(2)
    with col1:
        st.metric(
            label="Total Refund", 
            value=f"Rp {total_refund_value:,.0f}".replace(",", "."),
            delta="Nilai Kumulatif"
        )
    with col2:
        st.metric(
            label="Jumlah Data (Transaksi)", 
            value=f"{total_records:,}".replace(",", "."),
            delta="Total Baris"
        )

    st.divider()

    # --- 6. GRAFIK TREN BULANAN ---
    st.subheader("ðŸ“ˆ Tren Refund Bulanan")

    # Persiapan data untuk grafik
    # Kita buat kolom Periode (Tahun-Bulan) untuk grouping
    df['periode'] = df['cancel_time'].dt.strftime('%Y-%m')
    
    df_monthly = df.groupby('periode')['total_refund'].sum().reset_index()
    df_monthly = df_monthly.sort_values('periode') # Pastikan urutan kronologis

    # Membuat Bar Chart dengan Plotly
    if not df_monthly.empty:
        fig = px.bar(
            df_monthly,
            x='periode',
            y='total_refund',
            title="Total Refund per Bulan",
            labels={'total_refund': 'Nilai Refund (Rp)', 'periode': 'Bulan Pembatalan'},
            text_auto='.2s', # Menampilkan angka ringkas di atas bar
            color_discrete_sequence=['#FF4B4B'] # Warna identik dengan 'cancel/refund'
        )

        fig.update_layout(
            xaxis_type='category',
            hovermode="x unified",
            plot_bgcolor="rgba(0,0,0,0)",
            xaxis_tickangle=-45
        )

        st.plotly_chart(fig, use_container_width=True)
    else:
        st.info("Data tidak cukup untuk membuat grafik tren.")

    # --- 7. DATA PREVIEW (DEBUGGING/OPSIONAL) ---
    with st.expander("Lihat Detail Data Mentah"):
        st.dataframe(df.head(100), use_container_width=True)

if __name__ == "__main__":
    main()
